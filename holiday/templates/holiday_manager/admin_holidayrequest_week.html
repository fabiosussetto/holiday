{% extends ajax_partials|yesno:"holiday_manager/tabbed_page_ajax.html,holiday_manager/tabbed_page.html" %}
{% load misc %}
{% load thumbnail %}
{% load webdesign %}

{% block tabheader %}
    <i class="icon-inbox"></i>
    <h3 class="">Holiday requests</h3>
{% endblock %}

{% block subtabnav %}
    {% include 'holiday_manager/elements/holiday_requests_tabs.html' %}
{% endblock %}

{% block widgetclass %}holiday-calendar{% endblock %}

{% block tabheadernav %}
    {% include 'holiday_manager/elements/holiday_requests_header.html' %}
{% endblock %}

{% block tabcontent %}
    <div class="cf calendar-wrap">
        <div class="user-rows">
            <div class="shade"></div>
            {% for author, _ in object_list %}
                    <div class="user-row">
                        <img src="{% thumbnail author.google_pic|default:'profiles/missing_pic.gif' 40x40 %}">
                        {{ author }}
                    </div>
            {% endfor %}
        </div>
        <div class="scroll-wrap">
            <div class="shade"></div>
            <div class="table-scroll">
                <table class="table holiday_week">
                    <tr>
                        {% for day in week_days %}
                            <th class="cal-day">
                                <span class="date-month">{{ day|date:"N" }}</span>
                                <span class="date-day">
                                    {{ day|date:"D j" }}
                                </span>
                            </th>
                        {% endfor %}
                    </tr>
                        {% for author, requests in object_list %}
                            <tr class="user-row">
                                {% in_date_range requests week_days %}
                            </tr>
                        {% endfor %}
                </table>
                <div id="submit">
                    <a class="btn">Submit request</a>
                </div>
            </div>
        </div>
    </div>
    
    <ul class="pager">
        <li class="previous">
            <a class="tab-link" href="{% url app:holiday_weekly project=curr_project kind=list_kind %}?start={{ prev }}">&larr; Prev week</a>
        </li>
        <li class="next">
            <a class="tab-link" href="{% url app:holiday_weekly project=curr_project kind=list_kind %}?start={{ next }}">Next week &rarr;</a>
        </li>
    </ul>
{% endblock %}

{% block extra_js %}
    <script>
        $.fn.scrollTo = function( target, options, callback ){
            if(typeof options == 'function' && arguments.length == 2){ callback = options; options = target; }
            var settings = $.extend({
              direction: 'vertical',
              scrollTarget  : target,
              offsetTop     : 50,
              duration      : 500,
              easing        : 'swing'
            }, options);
            return this.each(function(){
              var scrollPane = $(this);
              if (typeof settings.scrollTarget == "number") {
                var scrollTarget = settings.scrollTarget;
              } else {
                var scrollTarget = $(settings.scrollTarget, scrollPane);
                if (!scrollTarget.length) {
                    return;
                  }
              }
              if (settings.direction == 'vertical') {
                var scrollY = (typeof scrollTarget == "number") ? scrollTarget : scrollTarget.offset().top + scrollPane.scrollTop() - parseInt(settings.offsetTop);
                scrollPane.animate({scrollTop : scrollY }, parseInt(settings.duration), settings.easing, function(){
                    if (typeof callback == 'function') { callback.call(this); }
                  });
              } else {
                scrollPane.scrollLeft(0);
                var scrollX = (typeof scrollTarget == "number") ? scrollTarget : scrollTarget.offset().left - 500;
                scrollPane.scrollLeft(scrollX);
                //scrollPane.animate({scrollLeft : scrollX }, parseInt(settings.duration), settings.easing, function(){
                //    if (typeof callback == 'function') { callback.call(this); }
                //});
              }
            });
        }
        
        $('.table-scroll').scrollTo('.today', {direction: 'horizontal'});
        
        var isMouseDown = false,
            isHighlighted;
            
        function clear_selection() {
            $('.table-scroll .highlighted').removeClass("highlighted").empty();
            $('#submit').hide();
        }
        
        var current_row = null;
          $(".table-scroll td")
            .mousedown(function () {
              if (!isMouseDown) {
                // first selected cell
                $(this).addClass("selection-first");
                clear_selection();
              }
            
              isMouseDown = true;
              current_row = $(this).parent();
              $(this).removeClass("selection-first");
              
              $(this).toggleClass("highlighted");
              isHighlighted = $(this).hasClass("highlighted");
              if (isHighlighted) {
                $(this).html('<span></span>');
              }
              return false; // prevent text selection
            })
            .mouseover(function () {
              if (isMouseDown) {
                if (isHighlighted) {
                    $(this).html('<span></span>');
                  }
                $(this).toggleClass("highlighted", isHighlighted);
              }
              if (current_row && isHighlighted && current_row[0] != $(this).parent()[0]) {
                //console.log('changed');
              }
              
            })
            .bind("selectstart", function () {
              return false;
            })
        
          $(document)
            .mouseup(function () {
              isMouseDown = false;
              var scroll_offset = $('.table-scroll').scrollLeft();
              var top = $('.highlighted').first().position().top + 12;
              var hl_first_pos = $('.highlighted').first().position().left + scroll_offset;
              var hl_last_pos = $('.highlighted').last().position().left + scroll_offset;
              var left_pos = hl_first_pos + (hl_last_pos - hl_first_pos - $('#submit').width() + $('.highlighted').first().width()) / 2;
              $('#submit').css({
                top: top,
                left: left_pos
              }).show();
            });
            
            $(document).click(function(e) {
                if (!$(e.target).is('.table-scroll td')) {
                    clear_selection();
                }
            });
        
    </script>
{% endblock %}